{% extends "base.html" %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-white mb-2">Chat Browser</h1>
    <p class="text-purple-300">Browse your Telegram chats and channels</p>
</div>

<!-- Account Selection -->
<div class="glass rounded-lg mb-6">
    <div class="p-6 border-b border-purple-700/30">
        <h3 class="text-white font-semibold">Select Account</h3>
    </div>
    <div class="p-6">
        <div class="flex space-x-4">
            <div class="flex-1">
                <select id="account-select" class="w-full px-3 py-2 bg-purple-900/50 border border-purple-700/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="">Select an account</option>
                </select>
            </div>
            <button id="fetch-chats-btn" disabled class="bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white px-4 py-2 rounded-lg transition-colors">
                <i id="fetch-icon" class="fas fa-sync mr-2"></i>
                Fetch Chats
            </button>
        </div>
        
        <div id="no-accounts-warning" class="text-purple-300 text-sm mt-2 hidden">
            No accounts found. Please add an account first.
        </div>
        
        <div id="auth-warning" class="text-yellow-300 text-sm mt-2 hidden">
            <i class="fas fa-exclamation-triangle mr-1"></i>
            Selected account is not authenticated. Please authenticate it first.
        </div>
    </div>
</div>

<!-- Authentication Required Modal -->
<div id="auth-required-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/50"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="glass rounded-lg w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-white">Authentication Required</h3>
                <button id="close-auth-modal" class="text-purple-300 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="text-center">
                    <i class="fas fa-lock text-4xl text-yellow-400 mb-4"></i>
                    <p class="text-purple-200 mb-2">
                        The selected account needs to be authenticated before you can access chats.
                    </p>
                    <p class="text-purple-300 text-sm">
                        Go to Account Management to authenticate your account.
                    </p>
                </div>
                
                <div class="flex justify-center space-x-2 pt-4">
                    <button id="close-auth-modal-btn" class="px-4 py-2 text-purple-300 hover:text-white transition-colors">
                        Close
                    </button>
                    <a href="/accounts" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-shield-alt mr-2"></i>Go to Accounts
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chats Table -->
<div id="chats-section" class="hidden">
    <div class="glass rounded-lg">
        <div class="p-6 border-b border-purple-700/30">
            <div class="flex justify-between items-center">
                <h3 class="text-white font-semibold flex items-center">
                    <i class="fas fa-comments mr-2"></i>
                    Available Chats
                </h3>
                <div class="text-sm text-purple-300">
                    Total: <span id="chat-count">0</span> chats
                </div>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-purple-700/30">
                        <th class="text-left py-3 px-6 text-purple-200 font-medium">Type</th>
                        <th class="text-left py-3 px-6 text-purple-200 font-medium">Name</th>
                        <th class="text-left py-3 px-6 text-purple-200 font-medium">Chat ID</th>
                        <th class="text-left py-3 px-6 text-purple-200 font-medium">Members</th>
                    </tr>
                </thead>
                <tbody id="chats-table-body">
                    <!-- Chats will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- No chats message -->
<div id="no-chats-message" class="glass rounded-lg text-center py-12 hidden">
    <i class="fas fa-comments text-6xl text-purple-400 mb-4"></i>
    <h3 class="text-xl font-semibold text-white mb-2">No chats loaded</h3>
    <p class="text-purple-300 mb-6">Select an account and click "Fetch Chats" to load your Telegram conversations</p>
</div>
{% endblock %}

{% block scripts %}
<script>
    let accounts = [];
    let chats = [];

    // DOM elements
    const accountSelect = document.getElementById('account-select');
    const fetchChatsBtn = document.getElementById('fetch-chats-btn');
    const fetchIcon = document.getElementById('fetch-icon');
    const chatsSection = document.getElementById('chats-section');
    const chatsTableBody = document.getElementById('chats-table-body');
    const noChatsMessage = document.getElementById('no-chats-message');
    const authRequiredModal = document.getElementById('auth-required-modal');
    const authWarning = document.getElementById('auth-warning');
    const chatCount = document.getElementById('chat-count');

    // Load accounts
    async function loadAccounts() {
        try {
            accounts = await apiCall('/api/accounts');
            
            accountSelect.innerHTML = '<option value="">Select an account</option>';
            accounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account.id;
                option.textContent = `${account.name} (${account.phone_number})${account.is_authenticated ? '' : ' - Not Authenticated'}`;
                option.dataset.authenticated = account.is_authenticated;
                accountSelect.appendChild(option);
            });

            if (accounts.length === 0) {
                document.getElementById('no-accounts-warning').classList.remove('hidden');
            } else {
                // Auto-select first authenticated account
                const firstAuthAccount = accounts.find(acc => acc.is_authenticated);
                if (firstAuthAccount) {
                    accountSelect.value = firstAuthAccount.id;
                    updateFetchButton();
                }
            }
        } catch (error) {
            console.error('Error loading accounts:', error);
            showToast('Failed to load accounts', 'error');
        }
    }

    // Update fetch button state based on selected account
    function updateFetchButton() {
        const selectedOption = accountSelect.options[accountSelect.selectedIndex];
        const isAuthenticated = selectedOption && selectedOption.dataset.authenticated === 'true';
        
        fetchChatsBtn.disabled = !accountSelect.value || !isAuthenticated;
        
        if (accountSelect.value && !isAuthenticated) {
            authWarning.classList.remove('hidden');
        } else {
            authWarning.classList.add('hidden');
        }
    }

    // Fetch chats
    async function fetchChats() {
        const accountId = accountSelect.value;
        if (!accountId) return;

        const selectedOption = accountSelect.options[accountSelect.selectedIndex];
        const isAuthenticated = selectedOption.dataset.authenticated === 'true';
        
        if (!isAuthenticated) {
            authRequiredModal.classList.remove('hidden');
            return;
        }

        fetchChatsBtn.disabled = true;
        fetchIcon.className = 'fas fa-spinner fa-spin mr-2';

        try {
            const response = await apiCall('/api/chats/list', {
                method: 'POST',
                body: JSON.stringify({ account_id: parseInt(accountId) })
            });

            chats = response.chats || [];
            renderChats();
            showToast(`Found ${chats.length} chats`);
        } catch (error) {
            console.error('Error fetching chats:', error);
            
            if (error.message.includes('requires_auth') || error.message.includes('not authenticated')) {
                authRequiredModal.classList.remove('hidden');
                // Update account authentication status
                loadAccounts();
            } else {
                showToast('Failed to fetch chats from Telegram', 'error');
            }
        } finally {
            fetchChatsBtn.disabled = !accountSelect.value;
            fetchIcon.className = 'fas fa-sync mr-2';
            updateFetchButton();
        }
    }

    // Render chats in table format
    function renderChats() {
        if (chats.length === 0) {
            chatsSection.classList.add('hidden');
            noChatsMessage.classList.remove('hidden');
        } else {
            chatsSection.classList.remove('hidden');
            noChatsMessage.classList.add('hidden');
            chatCount.textContent = chats.length;

            chatsTableBody.innerHTML = chats.map(chat => `
                <tr class="border-b border-purple-700/10 hover:bg-purple-900/20 transition-colors">
                    <td class="py-4 px-6">
                        <div class="flex items-center">
                            <i class="fas ${getChatIcon(chat.type)} mr-2"></i>
                            <span class="text-white font-medium capitalize">${chat.type}</span>
                        </div>
                    </td>
                    <td class="py-4 px-6">
                        <div class="text-white font-medium">${escapeHtml(chat.title)}</div>
                    </td>
                    <td class="py-4 px-6">
                        <div class="text-purple-300 font-mono text-sm">${chat.id}</div>
                    </td>
                    <td class="py-4 px-6">
                        <div class="text-purple-200">
                            ${chat.participant_count ? chat.participant_count.toLocaleString() : 'N/A'}
                        </div>
                    </td>
                </tr>
            `).join('');
        }
    }

    // Get chat icon based on type
    function getChatIcon(type) {
        switch (type) {
            case 'private': return 'fa-user text-blue-400';
            case 'group': return 'fa-users text-green-400';
            case 'channel': return 'fa-hashtag text-purple-400';
            default: return 'fa-comments text-gray-400';
        }
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Close auth required modal
    function closeAuthModal() {
        authRequiredModal.classList.add('hidden');
    }

    // Event listeners
    accountSelect.addEventListener('change', updateFetchButton);
    fetchChatsBtn.addEventListener('click', fetchChats);

    document.getElementById('close-auth-modal').addEventListener('click', closeAuthModal);
    document.getElementById('close-auth-modal-btn').addEventListener('click', closeAuthModal);

    // Close modal when clicking outside
    authRequiredModal.addEventListener('click', (e) => {
        if (e.target === authRequiredModal) {
            closeAuthModal();
        }
    });

    // Load data on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadAccounts();
    });
</script>
{% endblock %}